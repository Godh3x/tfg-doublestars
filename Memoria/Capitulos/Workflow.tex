%---------------------------------------------------------------------
%
%                          Capítulo 5
%
%---------------------------------------------------------------------
% !TEX root = ../Tesis.tex

\chapter{Workflow}
\label{cap5}

\begin{resumen}
Una vez resuelta la recolección de datos es necesario ver qué tratamientos
aplicarles para alcanzar nuestro objetivo, pero antes vamos a definir una
plataforma genérica sobre la cuál desarrollar dichos procesos.
\end{resumen}

%-------------------------------------------------------------------
\section{Introducción}
%-------------------------------------------------------------------
\label{cap5:sec:introduccion}

En los capítulos \ref{cap3} y \ref{cap4} se describen diferentes procesos por
los que una fotografía ha de pasar para poder detectar sistemas de estrellas
dobles. Cada una de estas etapas puede recibir un número arbitrario de entradas
y salidas, además recibirá un evento de la clase Thread de Python que al abortar
la ejecución, mediante la interrupción Ctrl+C, se activará permitiendo así a la
etapa saber que debe parar su ejecución. Por ejemplo, la etapa de recoloreado
que veremos en este capitulo recibe dos parámetros de entrada, uno de salida y
un evento en el que poder consultar, mediante la instrucción
``stop\_event.is\_set()'' si debe parar de ejecutarse.

\begin{lstlisting}[language=Python]
  def run(in_lista, in_dimages, out_dout, stop_event):
\end{lstlisting}

\medskip

Cada etapa por tanto puede ser configurada y lanzada por separado puesto que
para conectarlas solo es necesario que su salida sea la entrada de la siguiente.
De esta forma todas las etapas pueden trabajar de forma simultánea. Sin embargo,
creemos que esta tarea puede simplificarse mediante la creación de un
mecanismo de flujo de datos, que tiene la característica de que varios pasos se
pueden ejecutar simultáneamente. En nuestro caso es posible conseguir esta
concurrencia de tareas porque se asume que las etapas producen elementos de
salida de forma constante que las siguientes etapas pueden consumir. Está
filosofía recuerda a la empleada por la herramienta flume
(\url{https://flume.apache.org/}) en entornos Big Data, empleada para recibir y
operar con datos en streaming.


%-------------------------------------------------------------------
\section{Estructura}
%-------------------------------------------------------------------
\label{cap5:sec:estructura}

La idea es generar una estructura que permita al usuario definir el orden de las
etapas de manera sencilla, y una vez definidas las lance en diferentes hilos.
Una posible representación del workflow sería un grafo acíclico dirigido, es
importante que sea acíclico puesto que de otro modo la información nunca
llegaría a un estado definitivo en el cual se acepte o rechace.

\medskip

Podemos entonces definir cada fase como una entrada, una salida y un nombre de
función, de este modo conectar una etapa con otra tan solo implica igualar la
entrada de una a la salida de la otra. El nombre de función se almacena puesto
que a la hora de lanzar el hilo es necesario saber a qué función llamar.

\medskip

Existe un último, algunas etapas del workflow pueden tener más de una entrada o
salida por lo que se debe emplear un array de entradas y otro de salidas, debido
a esto también será necesario especificar el numero de entrada o salida a la que
se hace referencia al conectar los pasos.

\medskip

Una etapa se almacenara en el workflow empleando un diccionario, tendría por
tanto el siguiente formato.

\begin{lstlisting}[language=Python]
flow['step'] = {
  'input': [
    flow['other']['output'][0],
    settings.directory
  ],
  'output': [
    settings.directory2
  ],
  'callback': step.run,
}
\end{lstlisting}

Además se hace uso de una etapa \textit{dummy} que tan solo define la entrada
del primer paso en su salida. Una vez creadas las entradas en el diccionario
para todas las etapas solo será necesario ejecutar el workflow.

%-------------------------------------------------------------------
\section{Etapas}
%-------------------------------------------------------------------
\label{cap5:sec:etapas}

Si bien es cierto que el workflow esta pensado para dar libertad a la hora de
implementar las etapas tiene dos requisitos que se han de cumplir. El primero es
a la hora de definir el método que se utilizara como callback en el diccionario,
sus parámetros deben estar ordenados de modo que reciba primero todas las
entradas, luego todas las salidas y por ultimo un evento de las clase
\textit{threading}, este orden ha de ser tenido en cuenta a la hora de crear
la entrada del diccionario descrita en la sección \ref{cap5:sec:estructura}. En
segundo lugar se debe asegurar que la etapa se mantendrá a la espera de nuevos
datos que procesar hasta que se active el evento que se recibe por parámetro y
que una vez recibido no se abortara la ejecución del paso hasta que sea seguro.

\medskip

Para poder saber qué está pasando el workflow también monta un sistema de log,
utilizando la biblioteca \textit{logging} de python, al cual las etapas pueden
acceder para escribir mensajes de error o información de debug que le pueda ser
de utilidad al usuario para conocer que ha ocurrido.

\medskip

Debido a que las etapas se encuentran en continua ejecución podría darse el caso
en el que los mismos datos se procesen varias veces. Para prevenir esto las
etapas que hemos implementado mantienen su propio log de historia, por cada
dato procesado se almacena un identificador, normalmente el nombre.

%-------------------------------------------------------------------
\section{Uso}
%-------------------------------------------------------------------
\label{cap5:sec:uso}

Para utilizar el workflow son necesarios tres pasos.

\medskip

En primer lugar modificar el fichero de configuración, \textit{settings.py},
en el cual se encuentran almacenados todos los directorios de los pasos que
hemos creado y los parámetros de procesamiento que pueden modificarse de cada
etapa.

\medskip

Ir al workflow, \textit{workflow.py}, y editar la función
\textbf{define\_flow()} para crear el diccionario de etapas tal y como se ha
explicado en la sección \ref{cap5:sec:estructura}.

\medskip

Por último, ejecutar el workflow. Para parar el procesamiento basta con enviar
una interrupción, Ctrl+C, en la consola en la cual se haya lanzado.

